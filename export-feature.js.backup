/**
 * Export Feature for Silent Partners
 * Allows exporting visualization as PNG or SVG
 */

(function() {
    'use strict';
    
    console.log('üñºÔ∏è Export feature loading...');
    
    // Export as PNG using canvas
    function exportAsPNG() {
        console.log('üì∏ Starting PNG export...');
        
        const svg = document.getElementById('network-svg');
        if (!svg) {
            alert('No visualization to export!');
            return;
        }
        
        try {
            // Get actual rendered dimensions from the SVG element
            const rect = svg.getBoundingClientRect();
            const width = rect.width || 1200;
            const height = rect.height || 800;
            
            console.log(`SVG dimensions: ${width} x ${height}`);
            
            // Create canvas with higher resolution
            const scale = 2;
            const canvas = document.createElement('canvas');
            canvas.width = width * scale;
            canvas.height = height * scale;
            const ctx = canvas.getContext('2d');
            
            // Set white background
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Scale context
            ctx.scale(scale, scale);
            
            // Clone and prepare SVG
            const svgClone = svg.cloneNode(true);
            svgClone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
            
            // Remove viewBox to use explicit width/height
            svgClone.removeAttribute('viewBox');
            svgClone.setAttribute('width', width);
            svgClone.setAttribute('height', height);
            
            // Inline all styles
            const styleSheets = Array.from(document.styleSheets);
            let allStyles = '';
            styleSheets.forEach(sheet => {
                try {
                    const rules = Array.from(sheet.cssRules || []);
                    rules.forEach(rule => {
                        allStyles += rule.cssText + '\\n';
                    });
                } catch (e) {
                    // Skip external stylesheets due to CORS
                }
            });
            
            if (allStyles) {
                const styleElement = document.createElementNS('http://www.w3.org/2000/svg', 'style');
                styleElement.textContent = allStyles;
                svgClone.insertBefore(styleElement, svgClone.firstChild);
            }
            
            // Serialize SVG
            const svgString = new XMLSerializer().serializeToString(svgClone);
            const svgBlob = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
            const url = URL.createObjectURL(svgBlob);
            
            // Load into image
            const img = new Image();
            
            img.onload = function() {
                console.log('‚úÖ Image loaded successfully');
                
                // Draw to canvas
                ctx.drawImage(img, 0, 0, width, height);
                
                // Convert to PNG
                canvas.toBlob(function(blob) {
                    if (!blob || blob.size === 0) {
                        console.error('‚ùå Failed to create PNG blob');
                        alert('Failed to export PNG. Please try SVG export instead.');
                        return;
                    }
                    
                    console.log(`‚úÖ PNG blob created: ${blob.size} bytes`);
                    
                    // Download
                    const link = document.createElement('a');
                    const networkTitle = document.getElementById('network-title')?.value || 'network';
                    const filename = `${networkTitle.replace(/\\s+/g, '_')}_${Date.now()}.png`;
                    link.download = filename;
                    link.href = URL.createObjectURL(blob);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Cleanup
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                        URL.revokeObjectURL(link.href);
                    }, 100);
                    
                    console.log('‚úÖ PNG exported:', filename);
                }, 'image/png', 0.95);
            };
            
            img.onerror = function(e) {
                console.error('‚ùå Failed to load SVG image:', e);
                alert('PNG export failed. Please use SVG export instead, which works perfectly.');
                URL.revokeObjectURL(url);
            };
            
            img.src = url;
            
        } catch (e) {
            console.error('‚ùå PNG export error:', e);
            alert('Failed to export PNG: ' + e.message);
        }
    }
    
    // Export as SVG
    function exportAsSVG() {
        const svg = document.getElementById('network-svg');
        if (!svg) {
            alert('No visualization to export!');
            return;
        }
        
        // Clone SVG
        const svgClone = svg.cloneNode(true);
        
        // Add XML namespace if not present
        svgClone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
        
        // Serialize to string
        const svgData = new XMLSerializer().serializeToString(svgClone);
        
        // Create blob and download
        const blob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        const networkTitle = document.getElementById('network-title')?.value || 'network';
        const filename = `${networkTitle.replace(/\\s+/g, '_')}_${Date.now()}.svg`;
        link.download = filename;
        link.href = url;
        link.click();
        
        // Cleanup
        URL.revokeObjectURL(link.href);
        console.log('‚úÖ SVG exported:', filename);
    }
    
    // Attach event handlers to export buttons
    function attachExportHandlers() {
        const pngButton = document.getElementById('export-png-btn');
        const svgButton = document.getElementById('export-svg-btn');
        
        if (pngButton && svgButton) {
            pngButton.onclick = exportAsPNG;
            svgButton.onclick = exportAsSVG;
            console.log('‚úÖ Export button handlers attached');
        } else {
            console.warn('Export buttons not found in DOM');
        }
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attachExportHandlers);
    } else {
        attachExportHandlers();
    }
    
    // Export functions to global scope
    window.silentPartners = window.silentPartners || {};
    window.silentPartners.exportAsPNG = exportAsPNG;
    window.silentPartners.exportAsSVG = exportAsSVG;
    
    console.log('‚úÖ Export feature loaded');
    
})();
